<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHub Copilot è®¾å¤‡è®¤è¯</title>
    <style>
      :root {
        --primary-color: #238636;
        --secondary-color: #0d1117;
        --text-color: #c9d1d9;
        --border-color: #30363d;
        --bg-color: #0d1117;
        --card-bg: #161b22;
        --hover-color: #2ea043;
        --warning-color: #d29922;
        --success-color: #238636;
        --error-color: #f85149;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica,
          Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        line-height: 1.5;
      }

      .container {
        width: 90%;
        max-width: 500px;
        padding: 2rem;
        background-color: var(--card-bg);
        border-radius: 6px;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      h1 {
        margin-top: 0;
        color: white;
        font-size: 1.5rem;
        text-align: center;
        margin-bottom: 1.5rem;
      }

      .code-display {
        background-color: var(--secondary-color);
        padding: 1.5rem;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        font-family: monospace;
        font-size: 2rem;
        text-align: center;
        letter-spacing: 0.25rem;
        margin: 1.5rem 0;
        color: white;
        position: relative;
        transition: border-color 0.2s ease;
      }

      .code-display-hint {
        font-size: 0.75rem;
        color: #8b949e;
        text-align: center;
        margin-top: -1rem;
        margin-bottom: 1rem;
      }

      .instructions {
        margin-bottom: 1.5rem;
        text-align: center;
      }

      .steps {
        text-align: left;
        margin: 1.5rem 0;
        padding: 1rem;
        background-color: var(--secondary-color);
        border-radius: 6px;
        border: 1px solid var(--border-color);
      }

      .step {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.5rem 0;
        opacity: 0.6;
        transition: opacity 0.3s ease;
      }

      .step.active {
        opacity: 1;
      }

      .step.completed {
        opacity: 0.8;
      }

      .step-number {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: var(--border-color);
        color: var(--text-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
        flex-shrink: 0;
        transition: all 0.3s ease;
      }

      .step.active .step-number {
        background-color: var(--primary-color);
        color: white;
      }

      .step.completed .step-number {
        background-color: var(--success-color);
        color: white;
      }

      .step.completed .step-number::after {
        content: "âœ“";
      }

      .step.completed .step-number span {
        display: none;
      }

      .step-text {
        flex: 1;
        font-size: 0.9rem;
      }

      .button-group {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .btn {
        padding: 0.75rem 1rem;
        border-radius: 6px;
        border: none;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-primary {
        background-color: var(--primary-color);
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background-color: var(--hover-color);
      }

      .btn-primary:active:not(:disabled) {
        background-color: #1a7f2c;
      }

      .btn-secondary {
        background-color: transparent;
        color: var(--text-color);
        border: 1px solid var(--border-color);
      }

      .btn-secondary:hover:not(:disabled) {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .btn-confirm {
        background-color: var(--warning-color);
        color: white;
      }

      .btn-confirm:hover:not(:disabled) {
        background-color: #e3a826;
      }

      .btn-confirm:active:not(:disabled) {
        background-color: #c4911e;
      }

      .btn-loading {
        position: relative;
        color: transparent !important;
      }

      .btn-loading::after {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        border: 2px solid transparent;
        border-top-color: white;
        border-radius: 50%;
        -webkit-animation: spin 0.8s linear infinite;
        animation: spin 0.8s linear infinite;
      }

      @-webkit-keyframes spin {
        to {
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg);
        }
      }

      @keyframes spin {
        to {
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg);
        }
      }

      .github-logo {
        display: flex;
        justify-content: center;
        margin-bottom: 1rem;
      }

      .github-logo svg {
        width: 40px;
        height: 40px;
        fill: white;
      }

      .status {
        text-align: center;
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 6px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
      }

      .status.waiting {
        background-color: rgba(139, 148, 158, 0.1);
        color: #8b949e;
      }

      .status.processing {
        background-color: rgba(210, 153, 34, 0.1);
        color: var(--warning-color);
      }

      .status.success {
        background-color: rgba(35, 134, 54, 0.1);
        color: var(--success-color);
      }

      .status.error {
        background-color: rgba(248, 81, 73, 0.1);
        color: var(--error-color);
      }

      .timer {
        font-size: 0.8rem;
        color: #8b949e;
        text-align: center;
        margin-top: 0.5rem;
      }

      .hidden {
        display: none !important;
      }

      /* Safari é“¾æ¥æŒ‰é’®æ ·å¼ */
      a.btn {
        text-decoration: none;
        box-sizing: border-box;
      }

      @media (max-width: 600px) {
        .container {
          width: 100%;
          border-radius: 0;
          border-left: none;
          border-right: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="github-logo">
        <svg viewBox="0 0 16 16">
          <path
            d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"
          ></path>
        </svg>
      </div>
      <h1>GitHub Copilot è®¾å¤‡è®¤è¯</h1>

      <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
      <div class="steps">
        <div class="step active" id="step1">
          <div class="step-number"><span>1</span></div>
          <div class="step-text">å¤åˆ¶è®¾å¤‡ç å¹¶å‰å¾€ GitHub éªŒè¯</div>
        </div>
        <div class="step" id="step2">
          <div class="step-number"><span>2</span></div>
          <div class="step-text">åœ¨ GitHub é¡µé¢è¾“å…¥è®¾å¤‡ç å¹¶æˆæƒ</div>
        </div>
        <div class="step" id="step3">
          <div class="step-number"><span>3</span></div>
          <div class="step-text">è¿”å›æ­¤é¡µé¢ç¡®è®¤å®Œæˆ</div>
        </div>
      </div>

      <!-- è®¾å¤‡ç æ˜¾ç¤º -->
      <div class="code-display" id="userCode">{{ user_code }}</div>
      <div class="code-display-hint">è¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶ä¸Šæ–¹è®¾å¤‡ç </div>

      <!-- æŒ‰é’®ç»„ -->
      <div class="button-group">
        <!-- ä½¿ç”¨ <a> æ ‡ç­¾ä»£æ›¿ buttonï¼Œä»¥ç¡®ä¿ Safari å…¼å®¹æ€§ -->
        <a href="{{ verification_uri }}" target="_blank" rel="noopener noreferrer" class="btn btn-primary" id="openGitHub">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2Zm6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1Z"/>
          </svg>
          å‰å¾€ GitHub éªŒè¯
        </a>
        <button type="button" class="btn btn-confirm hidden" id="confirmBtn">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/>
          </svg>
          æˆ‘å·²å®ŒæˆéªŒè¯
        </button>
      </div>

      <!-- çŠ¶æ€æç¤º -->
      <div class="status waiting" id="status">
        <span id="statusIcon">â³</span>
        <span id="statusText">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹éªŒè¯æµç¨‹</span>
      </div>
      <div class="timer hidden" id="timer">éªŒè¯ç æœ‰æ•ˆæœŸå‰©ä½™ï¼š<span id="countdown">15:00</span></div>
    </div>

    <script>
      (function() {
        "use strict";

        // çŠ¶æ€ç®¡ç†
        var state = {
          step: 1,
          githubOpened: false,
          verifying: false,
          countdownStarted: false,
          expiresAt: Date.now() + 15 * 60 * 1000 // 15åˆ†é’Ÿæœ‰æ•ˆæœŸ
        };

        // DOM å…ƒç´ 
        var elements = {
          openGitHub: document.getElementById("openGitHub"),
          confirmBtn: document.getElementById("confirmBtn"),
          status: document.getElementById("status"),
          statusIcon: document.getElementById("statusIcon"),
          statusText: document.getElementById("statusText"),
          timer: document.getElementById("timer"),
          countdown: document.getElementById("countdown"),
          step1: document.getElementById("step1"),
          step2: document.getElementById("step2"),
          step3: document.getElementById("step3")
        };

        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStep(step) {
          state.step = step;
          var stepElements = [elements.step1, elements.step2, elements.step3];
          for (var i = 0; i < stepElements.length; i++) {
            var el = stepElements[i];
            el.classList.remove("active", "completed");
            if (i + 1 < step) {
              el.classList.add("completed");
            } else if (i + 1 === step) {
              el.classList.add("active");
            }
          }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(type, icon, text) {
          elements.status.className = "status " + type;
          elements.statusIcon.textContent = icon;
          elements.statusText.textContent = text;
        }

        // å€’è®¡æ—¶
        function startCountdown() {
          elements.timer.classList.remove("hidden");
          var interval = setInterval(function() {
            var remaining = state.expiresAt - Date.now();
            if (remaining <= 0) {
              clearInterval(interval);
              updateStatus("error", "âš ï¸", "éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°è·å–");
              elements.openGitHub.style.pointerEvents = "none";
              elements.openGitHub.style.opacity = "0.6";
              elements.confirmBtn.disabled = true;
              return;
            }
            var minutes = Math.floor(remaining / 60000);
            var seconds = Math.floor((remaining % 60000) / 1000);
            var minStr = minutes < 10 ? "0" + minutes : "" + minutes;
            var secStr = seconds < 10 ? "0" + seconds : "" + seconds;
            elements.countdown.textContent = minStr + ":" + secStr;
          }, 1000);
        }

        // ç‚¹å‡»å‰å¾€ GitHub éªŒè¯ï¼ˆ<a> æ ‡ç­¾ä¼šè‡ªåŠ¨æ‰“å¼€é“¾æ¥ï¼‰
        elements.openGitHub.addEventListener("click", function(e) {
          // æ›´æ–°çŠ¶æ€
          state.githubOpened = true;
          updateStep(2);
          updateStatus("processing", "ğŸ”—", "å·²æ‰“å¼€ GitHub éªŒè¯é¡µé¢ï¼Œè¯·åœ¨æ–°çª—å£ä¸­å®Œæˆæˆæƒ");

          // æ˜¾ç¤ºç¡®è®¤æŒ‰é’®
          elements.confirmBtn.classList.remove("hidden");

          // ä¿®æ”¹é“¾æ¥æ–‡å­—
          elements.openGitHub.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2Zm6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1Z"/></svg> é‡æ–°æ‰“å¼€éªŒè¯é¡µé¢';

          // å¯åŠ¨å€’è®¡æ—¶
          if (!state.countdownStarted) {
            state.countdownStarted = true;
            startCountdown();
          }
        }, false);

        // ç‚¹å‡»ç¡®è®¤éªŒè¯
        elements.confirmBtn.addEventListener("click", function(e) {
          e.preventDefault();

          if (state.verifying) return;
          state.verifying = true;

          updateStep(3);
          updateStatus("processing", "â³", "æ­£åœ¨éªŒè¯æˆæƒçŠ¶æ€...");
          elements.confirmBtn.classList.add("btn-loading");
          elements.confirmBtn.disabled = true;

          // å‘é€ç¡®è®¤è¯·æ±‚ - ä½¿ç”¨ XMLHttpRequest ç¡®ä¿å…¼å®¹æ€§
          var xhr = new XMLHttpRequest();
          xhr.open("POST", "/auth/confirm/{{ device_code }}", true);
          xhr.setRequestHeader("Content-Type", "application/json");

          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
              if (xhr.status === 200) {
                try {
                  var data = JSON.parse(xhr.responseText);
                  if (data.success) {
                    elements.step3.classList.remove("active");
                    elements.step3.classList.add("completed");
                    elements.confirmBtn.classList.remove("btn-loading", "btn-confirm");
                    elements.confirmBtn.classList.add("btn-primary");
                    elements.confirmBtn.innerHTML = "âœ“ è®¤è¯å®Œæˆ";
                    elements.openGitHub.classList.add("hidden");
                    elements.timer.classList.add("hidden");
                    updateStatus("success", "âœ…", "è®¤è¯æˆåŠŸï¼æ‚¨å¯ä»¥å®‰å…¨å…³é—­æ­¤é¡µé¢äº†");
                  } else {
                    handleError(data.error || "æœªçŸ¥é”™è¯¯");
                  }
                } catch (parseError) {
                  handleError("å“åº”è§£æå¤±è´¥");
                }
              } else {
                handleError("è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : " + xhr.status);
              }
            }
          };

          xhr.onerror = function() {
            handleError("ç½‘ç»œè¯·æ±‚å¤±è´¥");
          };

          xhr.send();
        }, false);

        // é”™è¯¯å¤„ç†
        function handleError(message) {
          state.verifying = false;
          elements.confirmBtn.classList.remove("btn-loading");
          elements.confirmBtn.disabled = false;

          // åˆ¤æ–­æ˜¯å¦æ˜¯"å°šæœªæˆæƒ"çš„æƒ…å†µ
          if (message.indexOf("authorization_pending") !== -1 || message.indexOf("ç­‰å¾…") !== -1) {
            updateStatus("processing", "â³", "æ‚¨ä¼¼ä¹å°šæœªåœ¨ GitHub å®Œæˆæˆæƒï¼Œè¯·å…ˆå®Œæˆæˆæƒåå†ç‚¹å‡»ç¡®è®¤");
            updateStep(2);
          } else if (message.indexOf("expired") !== -1 || message.indexOf("è¿‡æœŸ") !== -1) {
            updateStatus("error", "âš ï¸", "éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°è·å–");
            elements.openGitHub.style.pointerEvents = "none";
            elements.openGitHub.style.opacity = "0.6";
            elements.confirmBtn.disabled = true;
          } else {
            updateStatus("error", "âŒ", "éªŒè¯å¤±è´¥ï¼š" + message + "ï¼Œè¯·é‡è¯•");
          }
        }
      })();
    </script>
  </body>
</html>
