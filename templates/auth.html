<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHub Copilot 设备认证</title>

    <!-- Vue.js v3.5.13 -->
    <script src="https://registry.npmmirror.com/vue/3.5.13/files/dist/vue.global.prod.js"></script>

    <!-- Tailwind CSS v3.4.10 -->
    <script src="https://registry.npmmirror.com/tailwindcss-cdn/3.4.10/files/tailwindcss.js"></script>

    <!-- Font Awesome v6.7.2 -->
    <link
      rel="stylesheet"
      href="https://registry.npmmirror.com/@fortawesome/fontawesome-free/6.7.2/files/css/all.min.css"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              github: {
                bg: '#0d1117',
                card: '#161b22',
                border: '#30363d',
                text: '#c9d1d9',
                muted: '#8b949e',
                primary: '#238636',
                'primary-hover': '#2ea043',
                warning: '#d29922',
                success: '#238636',
                error: '#f85149',
              }
            }
          }
        }
      }
    </script>

    <style>
      [v-cloak] { display: none; }
    </style>
  </head>
  <body class="bg-github-bg text-github-text min-h-screen flex items-center justify-center font-sans">
    <div id="app" v-cloak>
      <div class="w-[90%] max-w-[500px] p-8 bg-github-card rounded-md border border-github-border shadow-lg mx-auto">
        <!-- GitHub Logo -->
        <div class="flex justify-center mb-4">
          <i class="fa-brands fa-github text-white text-5xl"></i>
        </div>

        <!-- 标题 -->
        <h1 class="text-white text-xl font-semibold text-center mb-6">GitHub Copilot 设备认证</h1>

        <!-- 步骤指示器 -->
        <div class="bg-github-bg rounded-md border border-github-border p-4 mb-6">
          <div
            v-for="(stepItem, index) in steps"
            :key="index"
            class="flex items-start gap-3 py-2 transition-opacity duration-300"
            :class="{
              'opacity-100': currentStep === index + 1,
              'opacity-80': currentStep > index + 1,
              'opacity-40': currentStep < index + 1
            }"
          >
            <!-- 步骤数字/勾选 -->
            <div
              class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 transition-all duration-300"
              :class="{
                'bg-github-primary text-white': currentStep === index + 1,
                'bg-github-success text-white': currentStep > index + 1,
                'bg-github-border text-github-text': currentStep < index + 1
              }"
            >
              <i v-if="currentStep > index + 1" class="fa-solid fa-check"></i>
              <span v-else>{{ index + 1 }}</span>
            </div>
            <!-- 步骤文字 -->
            <div class="flex-1 text-sm">{{ stepItem }}</div>
          </div>
        </div>

        <!-- 设备码显示 -->
        <div
          class="bg-github-bg p-6 rounded-md border border-github-border font-mono text-3xl text-center text-white tracking-widest mb-6"
        >
          {{ userCode }}
        </div>

        <!-- 按钮组 -->
        <div class="flex flex-col gap-3">
          <!-- 前往 GitHub 验证 -->
          <a
            :href="verificationUri"
            target="_blank"
            rel="noopener noreferrer"
            class="btn-primary flex items-center justify-center gap-2 py-3 px-4 rounded-md font-medium transition-all duration-200 no-underline"
            :class="{ 'opacity-60 pointer-events-none': isExpired }"
            @click="onOpenGitHub"
          >
            <i class="fa-solid fa-arrow-up-right-from-square"></i>
            <span>{{ githubOpened ? '重新打开验证页面' : '前往 GitHub 验证' }}</span>
          </a>

          <!-- 确认验证按钮 -->
          <button
            v-show="githubOpened"
            type="button"
            class="btn-confirm flex items-center justify-center gap-2 py-3 px-4 rounded-md font-medium transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed"
            :class="{
              'btn-loading': isVerifying,
              'btn-success': isSuccess
            }"
            :disabled="isVerifying || isExpired || isSuccess"
            @click="onConfirm"
          >
            <template v-if="isSuccess">
              <i class="fa-solid fa-check"></i>
              <span>认证完成</span>
            </template>
            <template v-else-if="!isVerifying">
              <i class="fa-solid fa-check-double"></i>
              <span>我已完成验证</span>
            </template>
          </button>
        </div>

        <!-- 状态提示 -->
        <div
          class="text-center mt-4 p-3 rounded-md text-sm transition-all duration-300"
          :class="statusClass"
        >
          <i :class="statusIcon" class="mr-2"></i>
          <span>{{ statusText }}</span>
        </div>

        <!-- 倒计时 -->
        <div
          v-show="countdownStarted"
          class="text-xs text-github-muted text-center mt-2"
        >
          <i class="fa-regular fa-clock mr-1"></i>
          验证码有效期剩余：<span class="font-mono">{{ countdownDisplay }}</span>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed, onMounted, onUnmounted } = Vue;

      createApp({
        setup() {
          // 从模板传入的数据
          const userCode = ref('{{ user_code }}');
          const deviceCode = ref('{{ device_code }}');
          const verificationUri = ref('{{ verification_uri }}');

          // 步骤定义
          const steps = [
            '复制设备码并前往 GitHub 验证',
            '在 GitHub 页面输入设备码并授权',
            '返回此页面确认完成'
          ];

          // 状态
          const currentStep = ref(1);
          const githubOpened = ref(false);
          const isVerifying = ref(false);
          const isSuccess = ref(false);
          const isExpired = ref(false);
          const countdownStarted = ref(false);
          const remainingSeconds = ref(15 * 60);
          const statusType = ref('waiting');
          const statusMessage = ref('点击上方按钮开始验证流程');

          let countdownInterval = null;

          // 计算属性
          const countdownDisplay = computed(() => {
            const minutes = Math.floor(remainingSeconds.value / 60);
            const seconds = remainingSeconds.value % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
          });

          const statusClass = computed(() => {
            const classes = {
              waiting: 'bg-github-muted/10 text-github-muted',
              processing: 'bg-github-warning/10 text-github-warning',
              success: 'bg-github-success/10 text-github-success',
              error: 'bg-github-error/10 text-github-error'
            };
            return classes[statusType.value] || classes.waiting;
          });

          const statusIcon = computed(() => {
            const icons = {
              waiting: 'fa-regular fa-hourglass-half',
              processing: 'fa-solid fa-spinner fa-spin',
              success: 'fa-solid fa-circle-check',
              error: 'fa-solid fa-circle-exclamation'
            };
            return icons[statusType.value] || icons.waiting;
          });

          const statusText = computed(() => statusMessage.value);

          // 方法
          const startCountdown = () => {
            if (countdownInterval) return;
            countdownStarted.value = true;

            countdownInterval = setInterval(() => {
              remainingSeconds.value--;
              if (remainingSeconds.value <= 0) {
                clearInterval(countdownInterval);
                isExpired.value = true;
                statusType.value = 'error';
                statusMessage.value = '验证码已过期，请刷新页面重新获取';
              }
            }, 1000);
          };

          const onOpenGitHub = () => {
            githubOpened.value = true;
            currentStep.value = 2;
            statusType.value = 'processing';
            statusMessage.value = '已打开 GitHub 验证页面，请在新窗口中完成授权';
            startCountdown();
          };

          const onConfirm = async () => {
            if (isVerifying.value || isExpired.value) return;

            isVerifying.value = true;
            currentStep.value = 3;
            statusType.value = 'processing';
            statusMessage.value = '正在验证授权状态...';

            try {
              const response = await fetch(`/auth/confirm/${deviceCode.value}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              });

              const data = await response.json();

              if (data.success) {
                isSuccess.value = true;
                statusType.value = 'success';
                statusMessage.value = '认证成功！您可以安全关闭此页面了';
                countdownStarted.value = false;
                if (countdownInterval) {
                  clearInterval(countdownInterval);
                }
              } else {
                handleError(data.error || '未知错误');
              }
            } catch (err) {
              handleError('网络请求失败');
            } finally {
              isVerifying.value = false;
            }
          };

          const handleError = (message) => {
            if (message.includes('authorization_pending') || message.includes('等待')) {
              statusType.value = 'processing';
              statusMessage.value = '您似乎尚未在 GitHub 完成授权，请先完成授权后再点击确认';
              currentStep.value = 2;
            } else if (message.includes('expired') || message.includes('过期')) {
              isExpired.value = true;
              statusType.value = 'error';
              statusMessage.value = '验证码已过期，请刷新页面重新获取';
            } else {
              statusType.value = 'error';
              statusMessage.value = `验证失败：${message}，请重试`;
            }
          };

          // 清理
          onUnmounted(() => {
            if (countdownInterval) {
              clearInterval(countdownInterval);
            }
          });

          return {
            userCode,
            deviceCode,
            verificationUri,
            steps,
            currentStep,
            githubOpened,
            isVerifying,
            isSuccess,
            isExpired,
            countdownStarted,
            countdownDisplay,
            statusClass,
            statusIcon,
            statusText,
            onOpenGitHub,
            onConfirm
          };
        }
      }).mount('#app');
    </script>

    <style>
      .btn-primary {
        background-color: #238636;
        color: white;
      }
      .btn-primary:hover:not(.opacity-60) {
        background-color: #2ea043;
      }

      .btn-confirm {
        background-color: #d29922;
        color: white;
      }
      .btn-confirm:hover:not(:disabled) {
        background-color: #e3a826;
      }

      .btn-success {
        background-color: #238636 !important;
      }

      .btn-loading {
        position: relative;
        color: transparent !important;
      }
      .btn-loading::after {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        border: 2px solid transparent;
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </body>
</html>
